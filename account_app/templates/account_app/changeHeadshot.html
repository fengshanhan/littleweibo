<!DOCTYPE html>
{% load staticfiles %}
<html>
    <head>
        <title>Personal homepage</title>

        <link  rel="stylesheet" type="text/css" href="{% static 'css/changeHeadshot.css' %}" />

        <script src="{% static 'js/cropper.js' %}" type="text/javascript" ></script>
        <script src="{% static 'js/jquery.js' %}" type="text/javascript" ></script>

<!--<link  rel="stylesheet" type="text/css" href="{% static 'css/cropper.css' %}" />

        <link rel="stylesheet" type="text/css" href="{% static 'css/navigation.css' %}"/>
        <link rel="stylesheet" type="text/css" href="{% static 'css/land.css' %}"/>
        <link rel="stylesheet" type="text/css" href="{% static 'css/initial.css' %}"/>
-->
        <!----<img src="{% static "imgs/bg.jpg" %}"/>----->
    </head>
    <body><!--
            <div class="bg bg-blur " ></div><div class="banner"><h1>l i t t l e&nbsp;&nbsp;&nbsp;w e i b o</h1></div>

    <div id="header">
		<div id="logo">
			<div class="touxiang">
				{% for i in user %}
                    <img src="{{MEDIA_URL}}{{i.headshot}} " >
                {% endfor %}
			</div>
			<p> userName <a href="#">个人简介</a></p>
		</div>

	</div>

<div id = "menu">
        <ul>
            <li><a class="active" href="{% url 'account_app:home' %}">Homepage</a></li><li><a>|</a></li>
            <li><a href="{% url 'account_app:release' %}">Release micro-blog</a></li><li><a>|</a></li>
            <li><a href="{% url 'account_app:RecentNews' %}">Recent News</a></li><li><a>|</a></li>
            <li><a href="{% url 'account_app:personal' %}">Personal homepage</a></li><li><a>|</a></li>
            <li><a href="{% url 'account_app:profile' %}">Profile</a></li><li><a>|</a></li>
            <li><a href="{% url 'account_app:logout' %}">Log out</a></li>
        </ul>
</div>


-->


            <div>
  <img id="image" src="picture.jpg">
</div>


    <div class="crop-picker-wrap">
      <button class="crop-picker" id='select' type="button">选择图片</button>
     <input type="file" class="crop-picker-file" id="inputImage" name="file" accept=".jpg,.jpeg,.png,.gif,.bmp,.tiff">>
        </div>
    //预览
  <div id="preview">
             {% if thumb_pic %}
             <img src="{{MEDIA_URL}}{{thumb_pic}}" id="target" />
             {% else%}
             <img src="" id="target" />
             {% endif %}
               <span>滚动放大或缩小</span>
          </div>
            // 显示裁剪的效果图
          <div id="preview-pane">
            <div class="preview-container">
                 <img src="" id="cut_thumb"/>
            </div>
            <span>160*160</span>
          </div>

           <div class="crop-operate">
                <button class="crop-save" type='submit' id='save'>保存</button>
                <button class="crop-cancel" type="button" id='cancel'>取消</button>
            </div>





    </body>

</html>
<script>
    var $image = $('#image');

$image.cropper({
  aspectRatio: 16 / 9,
  crop: function(event) {
    console.log(event.detail.x);
    console.log(event.detail.y);
    console.log(event.detail.width);
    console.log(event.detail.height);
    console.log(event.detail.rotate);
    console.log(event.detail.scaleX);
    console.log(event.detail.scaleY);
  }
});

//实例化
var cropper = $image.data('cropper');
</script>

<script>

    var $image = $('#target');
        $('[type=file]').change(function(e) {
            var file = e.target.files[0]
            if(file.size>= 2*1024*1024){
                  layer.alert('您上传的头像大于2M,请重新上传', {
                      title:'提示',
                      icon: 0,
                      skin:'layui-layer-lan', //该皮肤由layer.seaning.com友情扩展。关于皮肤的扩展规则，去这里查阅
                    });
                }
            else{
                    var reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload=function(e){
                    $image.attr("src",e.target.result)
                     $image.cropper('reset', true).cropper('replace',e.target.result);
                    }
                    if(($('#target').attr('src').length) != 0){
                         $('#preview').show()
                         $('#preview-pane').show()
                         $('.crop-operate').show()
                    }
                }
          })
            $image.cropper({
                        dragMode: 'move',
                        viewMode:3,
                        aspectRatio:1,//1 / 1,  //图片比例,1:1
                        minCropBoxWidth:300,
                        minCropBoxHeight:300,
                        minContainerWidth:300,
                        minContainerHeight:300,
                        restore: false,
                        guides: false,
                        center: false,
                        highlight: false,
                        cropBoxMovable: false,
                        cropBoxResizable: false,
                        toggleDragModeOnDblclick: false,
                        modal:false,
                        responsive:false,
                        preview:'.preview-container',
                        background:false,
                     });

 $('#thumb_upload').submit(function(){
      event.preventDefault();
      // 获取裁图后图片的base64
     var $imgData=$image.cropper('getCroppedCanvas')
      var dataurl = $imgData.toDataURL('image/jpeg');
     // 将base64 转为 blob格式
      var b64 = dataurl.split(',')[1];
     var binary = atob(b64);
     var array = [];
     for (var i = 0; i < binary.length; i++) {
         array.push(binary.charCodeAt(i));
     }
     var blob =  new Blob([new Uint8Array(array)], {type: 'image/jpeg'})
     // 使用FormData()进行ajax请求，上传图片
     var formData = new FormData()
     // 图片名字
     var img_name = new Date().getTime()+'.jpg';
     formData.append('csrfmiddlewaretoken','{{ csrf_token }}')
     formData.append('uploadFile',blob,img_name)
     var data = formData
      $.ajax({
           url: "/上传地址/",
           type: "post",
           dataType: "json",
           data:data,
           processData: false,
           contentType:false,
           success:function(result){
               if(result['state']==0){
                    layer.close(layer.index);
                    window.parent.location.reload();
               }
               if(result['state']==1){
                     layer.alert('上传失败,请联系客服', {
                          title:'提示',
                          icon: 0,
                          skin: 'layui-layer-lan'//该皮肤由layer.seaning.com友情扩展。关于皮肤的扩展规则，去这里查阅
                        },
                          function (){
                             window.parent.location.reload()
                        }
                    );
               }
           }
      });
  });

  $('#cancel').click(function(){
      event.preventDefault();
      var index = parent.layer.getFrameIndex(window.name);
      parent.layer.close(index);
  })



</script>